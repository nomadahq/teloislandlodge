<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TIL Concierge â€” Admin Panel</title>
<meta name="robots" content="noindex, nofollow">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',-apple-system,sans-serif;background:#0B0C0F;color:#E6EDF3;min-height:100vh}

.admin-bar{padding:.6rem 1.5rem;background:#0E9AA7;color:#fff;font-size:.65rem;font-weight:600;letter-spacing:.12em;text-transform:uppercase;display:flex;justify-content:space-between;align-items:center}

.layout{display:grid;grid-template-columns:220px 1fr;min-height:calc(100vh - 36px)}

.sidebar{background:#141518;border-right:1px solid #252830;padding:1.5rem 0}
.sidebar h2{font-family:'Playfair Display',Georgia,serif;font-size:1rem;font-weight:500;color:#F5F0EB;padding:0 1.2rem;margin-bottom:1.5rem}
.nav-item{display:flex;align-items:center;gap:.6rem;padding:.7rem 1.2rem;font-size:.8rem;color:#7D8590;cursor:pointer;transition:all .15s;border-left:3px solid transparent}
.nav-item:hover{background:rgba(255,255,255,.03);color:#B1BAC4}
.nav-item.active{background:rgba(232,97,58,.08);color:#E8613A;border-color:#E8613A}
.nav-item .count{margin-left:auto;font-size:.6rem;font-weight:600;padding:1px 6px;border-radius:8px;background:rgba(255,255,255,.06)}
.nav-item.active .count{background:rgba(232,97,58,.15);color:#E8613A}

.main{padding:2rem}
.main h1{font-family:'Playfair Display',Georgia,serif;font-size:1.3rem;font-weight:500;color:#F5F0EB;margin-bottom:.3rem}
.main .subtitle{color:#7D8590;font-size:.75rem;margin-bottom:1.5rem}

.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:2rem}
.stat-card{background:#141518;border:1px solid #252830;padding:1rem 1.2rem}
.stat-card .val{font-size:1.6rem;font-weight:600;color:#F5F0EB;font-family:'Playfair Display',Georgia,serif}
.stat-card .label{font-size:.6rem;letter-spacing:.12em;text-transform:uppercase;color:#7D8590;margin-top:.2rem}

.conv-list{display:flex;flex-direction:column;gap:.5rem}
.conv-card{background:#141518;border:1px solid #252830;padding:1rem 1.2rem;cursor:pointer;transition:all .15s}
.conv-card:hover{border-color:#E8613A40}
.conv-card.escalated{border-left:3px solid #F85149}
.conv-card.has-lead{border-left:3px solid #3FB950}
.conv-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem}
.conv-name{font-size:.85rem;font-weight:500;color:#F5F0EB}
.conv-time{font-size:.65rem;color:#7D8590}
.conv-preview{font-size:.75rem;color:#7D8590;line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.conv-tags{display:flex;gap:.3rem;margin-top:.4rem}
.tag{font-size:.55rem;padding:1px 6px;font-weight:600;letter-spacing:.08em;text-transform:uppercase}
.tag.lead{background:rgba(63,185,80,.12);color:#3FB950;border:1px solid rgba(63,185,80,.25)}
.tag.escalated{background:rgba(248,81,73,.12);color:#F85149;border:1px solid rgba(248,81,73,.25)}
.tag.active{background:rgba(14,154,167,.12);color:#0E9AA7;border:1px solid rgba(14,154,167,.25)}
.tag.msgs{background:rgba(255,255,255,.04);color:#7D8590;border:1px solid #252830}

.conv-detail{background:#141518;border:1px solid #252830;padding:1.5rem;margin-top:1rem}
.conv-detail h3{font-size:.85rem;font-weight:500;color:#F5F0EB;margin-bottom:1rem;font-family:'Playfair Display',Georgia,serif}
.msg{margin-bottom:.8rem;display:flex;gap:.8rem}
.msg .role{font-size:.55rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;min-width:50px;padding-top:2px}
.msg .role.user{color:#E8613A}
.msg .role.assistant{color:#0E9AA7}
.msg .text{font-size:.78rem;color:#B1BAC4;line-height:1.7;flex:1}
.msg .text strong{color:#F5F0EB}

.lead-list{display:flex;flex-direction:column;gap:.5rem}
.lead-card{background:#141518;border:1px solid #252830;padding:1rem 1.2rem;display:grid;grid-template-columns:1fr 1fr 120px 80px;gap:1rem;align-items:center}
.lead-email{font-size:.85rem;font-weight:500;color:#F5F0EB}
.lead-name{font-size:.8rem;color:#B1BAC4}
.lead-date{font-size:.7rem;color:#7D8590}
.lead-source{font-size:.55rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:#0E9AA7}

.empty{text-align:center;padding:3rem;color:#7D8590;font-size:.85rem}
.empty .icon{font-size:2rem;margin-bottom:.5rem;opacity:.3}

.loading{display:flex;justify-content:center;padding:2rem}
.loading span{width:6px;height:6px;border-radius:50%;background:#7D8590;margin:0 3px;animation:pulse 1.2s ease-in-out infinite}
.loading span:nth-child(2){animation-delay:.15s}
.loading span:nth-child(3){animation-delay:.3s}
@keyframes pulse{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}

@media(max-width:768px){
  .layout{grid-template-columns:1fr}
  .sidebar{display:none}
  .stats-row{grid-template-columns:repeat(2,1fr)}
  .lead-card{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="admin-bar">
  <span>TIL Concierge â€” Admin Panel</span>
  <span id="lastRefresh" style="font-weight:400;text-transform:none;letter-spacing:0;opacity:.7">Loading...</span>
</div>

<div class="layout">
  <div class="sidebar">
    <h2>Concierge</h2>
    <div class="nav-item active" onclick="showTab('overview')" id="nav-overview">
      <span>ðŸ“Š</span> Overview
    </div>
    <div class="nav-item" onclick="showTab('conversations')" id="nav-conversations">
      <span>ðŸ’¬</span> Conversations <span class="count" id="convCount">-</span>
    </div>
    <div class="nav-item" onclick="showTab('leads')" id="nav-leads">
      <span>ðŸŽ¯</span> Leads <span class="count" id="leadCount">-</span>
    </div>
    <div class="nav-item" onclick="showTab('escalations')" id="nav-escalations">
      <span>ðŸš¨</span> Escalations <span class="count" id="escCount">-</span>
    </div>
    <div class="nav-item" onclick="window.open('https://staging.teloislandlodge.pages.dev/staging/','_blank')">
      <span>ðŸ¤–</span> Open Concierge â†—
    </div>
  </div>

  <div class="main" id="content">
    <div class="loading"><span></span><span></span><span></span></div>
  </div>
</div>

<script>
const API_BASE = 'https://til-concierge-api.aaron-795.workers.dev';
let conversations = [];
let leads = [];
let stats = { totalConversations: 0, totalLeads: 0, totalEscalations: 0 };
let activeTab = 'overview';
let selectedConv = null;

async function fetchData() {
  try {
    const [statsRes, convsRes, leadsRes] = await Promise.all([
      fetch(`${API_BASE}/admin/stats`).then(r => r.json()).catch(() => ({ totalConversations: 0, totalLeads: 0, totalEscalations: 0 })),
      fetch(`${API_BASE}/admin/conversations`).then(r => r.json()).catch(() => []),
      fetch(`${API_BASE}/admin/leads`).then(r => r.json()).catch(() => []),
    ]);
    stats = statsRes;
    conversations = convsRes;
    leads = leadsRes;

    document.getElementById('convCount').textContent = stats.totalConversations;
    document.getElementById('leadCount').textContent = stats.totalLeads;
    document.getElementById('escCount').textContent = stats.totalEscalations;
    document.getElementById('lastRefresh').textContent = `Updated ${new Date().toLocaleTimeString()}`;
  } catch(e) {
    console.error('Fetch error:', e);
  }
  render();
}

function showTab(tab) {
  activeTab = tab;
  selectedConv = null;
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(`nav-${tab}`).classList.add('active');
  render();
}

function timeAgo(dateStr) {
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  return `${days}d ago`;
}

function formatMsg(text) {
  return text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
}

function render() {
  const el = document.getElementById('content');

  if (activeTab === 'overview') {
    const escalated = conversations.filter(c => c.escalated);
    const withLeads = conversations.filter(c => c.lead);
    el.innerHTML = `
      <h1>Dashboard</h1>
      <div class="subtitle">TIL Concierge performance at a glance</div>
      <div class="stats-row">
        <div class="stat-card"><div class="val">${stats.totalConversations}</div><div class="label">Conversations</div></div>
        <div class="stat-card"><div class="val">${stats.totalLeads}</div><div class="label">Leads Captured</div></div>
        <div class="stat-card"><div class="val">${stats.totalEscalations}</div><div class="label">Escalations</div></div>
        <div class="stat-card"><div class="val">${conversations.length > 0 ? Math.round(withLeads.length / conversations.length * 100) : 0}%</div><div class="label">Lead Capture Rate</div></div>
      </div>
      <h1 style="font-size:1rem;margin-bottom:1rem">Recent Activity</h1>
      ${conversations.length === 0 ? `
        <div class="empty"><div class="icon">ðŸ’¬</div>No conversations yet. Test the concierge to see data here.</div>
      ` : `
        <div class="conv-list">
          ${conversations.slice(0, 10).map(c => convCard(c)).join('')}
        </div>
      `}
    `;
  }

  if (activeTab === 'conversations') {
    el.innerHTML = `
      <h1>Conversations</h1>
      <div class="subtitle">${conversations.length} total conversations</div>
      ${conversations.length === 0 ? `
        <div class="empty"><div class="icon">ðŸ’¬</div>No conversations yet.</div>
      ` : `
        <div class="conv-list">
          ${conversations.map(c => convCard(c)).join('')}
        </div>
      `}
      ${selectedConv ? convDetail(selectedConv) : ''}
    `;
  }

  if (activeTab === 'leads') {
    el.innerHTML = `
      <h1>Captured Leads</h1>
      <div class="subtitle">${leads.length} leads from concierge conversations</div>
      ${leads.length === 0 ? `
        <div class="empty"><div class="icon">ðŸŽ¯</div>No leads captured yet. The concierge captures emails naturally during conversation.</div>
      ` : `
        <div class="lead-list">
          ${leads.map(l => `
            <div class="lead-card">
              <div class="lead-email">${l.email}</div>
              <div class="lead-name">${l.name || 'Name not captured'}</div>
              <div class="lead-date">${timeAgo(l.captured)}</div>
              <div class="lead-source">${l.source || 'chat'}</div>
            </div>
          `).join('')}
        </div>
      `}
    `;
  }

  if (activeTab === 'escalations') {
    const escalated = conversations.filter(c => c.escalated);
    el.innerHTML = `
      <h1>Escalations to Elle</h1>
      <div class="subtitle">${escalated.length} conversations escalated to human support</div>
      ${escalated.length === 0 ? `
        <div class="empty"><div class="icon">ðŸš¨</div>No escalations yet. When the concierge can't handle a request, it routes to Elle.</div>
      ` : `
        <div class="conv-list">
          ${escalated.map(c => convCard(c)).join('')}
        </div>
      `}
      ${selectedConv ? convDetail(selectedConv) : ''}
    `;
  }
}

function convCard(c) {
  const lastMsg = c.messages?.[c.messages.length - 1]?.content || 'No messages';
  const firstUserMsg = c.messages?.find(m => m.role === 'user')?.content || '';
  const displayName = c.lead?.name || c.lead?.email || 'Anonymous';
  return `
    <div class="conv-card ${c.escalated ? 'escalated' : ''} ${c.lead ? 'has-lead' : ''}" onclick="selectConv('${c.id}')">
      <div class="conv-header">
        <span class="conv-name">${displayName}</span>
        <span class="conv-time">${timeAgo(c.updated)}</span>
      </div>
      <div class="conv-preview">${firstUserMsg}</div>
      <div class="conv-tags">
        <span class="tag msgs">${c.messageCount || 0} msgs</span>
        ${c.lead ? '<span class="tag lead">Lead</span>' : ''}
        ${c.escalated ? '<span class="tag escalated">Escalated</span>' : ''}
      </div>
    </div>
  `;
}

function convDetail(conv) {
  return `
    <div class="conv-detail">
      <h3>Conversation â€” ${conv.lead?.name || conv.lead?.email || conv.id.slice(0, 8)}</h3>
      ${conv.lead ? `<div style="margin-bottom:1rem;padding:.6rem;background:rgba(63,185,80,.08);border:1px solid rgba(63,185,80,.2)">
        <span style="font-size:.65rem;color:#3FB950;font-weight:600">LEAD: </span>
        <span style="font-size:.8rem;color:#F5F0EB">${conv.lead.email}${conv.lead.name ? ' â€” ' + conv.lead.name : ''}</span>
      </div>` : ''}
      ${(conv.messages || []).map(m => `
        <div class="msg">
          <div class="role ${m.role}">${m.role === 'user' ? 'Guest' : 'AI'}</div>
          <div class="text">${formatMsg(m.content)}</div>
        </div>
      `).join('')}
    </div>
  `;
}

function selectConv(id) {
  selectedConv = conversations.find(c => c.id === id);
  render();
  // Scroll to detail
  setTimeout(() => document.querySelector('.conv-detail')?.scrollIntoView({ behavior: 'smooth' }), 100);
}

// Initial load + auto-refresh every 30 seconds
fetchData();
setInterval(fetchData, 30000);
</script>
</body>
</html>
